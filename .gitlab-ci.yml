image: usvc/ci-golang:gitlab-latest
services:
  - docker:dind
stages:
  - validation
  - versioning
  - release
variables:
  GIT_SUBMODULE_STRATEGY: recursive

run tests:
  stage: validation
  artifacts:
    untracked: false
    expire_in: 3 days
    paths:
      - ./c.out
  script:
    - make dep
    - make test

build binary:
  stage: validation
  artifacts:
    untracked: false
    expire_in: 3 days
    paths:
      - ./bin/semver
  script:
    - make dep
    - make binaries.all

build images:
  stage: validation
  script:
    - make images

bump:
  stage: versioning
  script:
    - 'printf -- "placeholder - we should bump the version here and push the tag back to gitlab"'

docker image:
  stage: release
  script:
    - docker login ${DOCKER_REGISTRY_URL} -u ${DOCKER_REGISTRY_USERNAME} -p ${DOCKER_REGISTRY_PASSWORD}
    - make publish_images
    - docker logout
